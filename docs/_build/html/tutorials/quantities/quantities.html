
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Using Astropy Quantities for astrophysical calculations &#8212; astropy-tutorials v3.0.dev</title>
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0.dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Make a plot with both redshift and universe age axes using astropy.cosmology" href="../redshift-plot/redshift-plot.html" />
    <link rel="prev" title="Read in catalog information from a text file and plot some parameters" href="../plot-catalog/plot-catalog.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../_static/copybutton.js"></script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:tutorials</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="../redshift-plot/redshift-plot.html" title="Make a plot with both redshift and universe age axes using astropy.cosmology">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="../plot-catalog/plot-catalog.html" title="Read in catalog information from a text file and plot some parameters">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../index.html">astropy-tutorials v3.0.dev</a>
	 &#187;
      </li>
      
      <li>Using Astropy Quantities for astrophysical calculations</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 0;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="section" id="Using-Astropy-Quantities-for-astrophysical-calculations">
<h1>Using Astropy Quantities for astrophysical calculations<a class="headerlink" href="#Using-Astropy-Quantities-for-astrophysical-calculations" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial we present some examples showing how astropy’s
<code class="docutils literal"><span class="pre">Quantity</span></code> object can make astrophysics calculations easier. The
examples include calculating the mass of a galaxy from its velocity
dispersion and determining masses of molecular clouds from CO intensity
maps. We end with an example of good practices for using quantities in
functions you might distribute to other people.</p>
<p>For an in-depth discussion of <code class="docutils literal"><span class="pre">Quantity</span></code> objects, see the <a class="reference external" href="http://docs.astropy.org/en/stable/units/quantity.html">astropy
documentation
section</a>.</p>
<div class="section" id="Preliminaries">
<h2>Preliminaries<a class="headerlink" href="#Preliminaries" title="Permalink to this headline">¶</a></h2>
<p>We start by loading standard libraries and set up plotting for ipython
notebooks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c1"># You shouldn&#39;t use the `seed` function in real science code, but we use it here for example purposes.</span>
<span class="c1"># It makes the &quot;random&quot; number generator always give the same numbers wherever you run it.</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># Set up matplotlib and use a nicer set of plot parameters</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">astropy_mpl_style</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">astropy_mpl_style</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<p>It is conventional to load the astropy <code class="docutils literal"><span class="pre">units</span></code> module as the variable
<code class="docutils literal"><span class="pre">u</span></code>, demonstrated below. This will make working with <code class="docutils literal"><span class="pre">Quantity</span></code>
objects much easier.</p>
<p>Astropy also has a <code class="docutils literal"><span class="pre">constants</span></code> module, where typical physical
constants are available. The constants are stored as objects of a
subclass of <code class="docutils literal"><span class="pre">Quantity</span></code>, so they behave just like a <code class="docutils literal"><span class="pre">Quantity</span></code>. Here,
we’ll only need the gravitational constant <code class="docutils literal"><span class="pre">G</span></code>, Planck’s constant
<code class="docutils literal"><span class="pre">h</span></code>, and Boltzmann’s constant, <code class="docutils literal"><span class="pre">k_B</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="kn">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="kn">import</span> <span class="n">G</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k_B</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="1.-Galaxy-mass">
<h2>1. Galaxy mass<a class="headerlink" href="#1.-Galaxy-mass" title="Permalink to this headline">¶</a></h2>
<p>In this first example, we will use <code class="docutils literal"><span class="pre">Quantity</span></code> objects to estimate a
hypothetical galaxy’s mass, given its half-light radius and radial
velocities of stars in the galaxy.</p>
<p>Lets assume that we measured the half light radius of the galaxy to be
29 pc projected on the sky at the distance of the galaxy. This radius is
often called the “effective radius”, so we will store it as a
<code class="docutils literal"><span class="pre">Quantity</span></code> object with the name <code class="docutils literal"><span class="pre">Reff</span></code>. The easiest way to create a
<code class="docutils literal"><span class="pre">Quantity</span></code> object is just by multiplying the value with its unit.
Units are accessed as u.”unit”, in this case u.pc.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">Reff</span> <span class="o">=</span> <span class="mi">29</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span>
</pre></div>
</div>
</div>
<p>A completely equivalent (but more verbose) way of doing the same thing
is to use the <code class="docutils literal"><span class="pre">Quantity</span></code> object’s initializer, demonstrated below. In
general, the simpler form (above) is preferred, as it is closer to how
such a quantity would actually be written in text. The initalizer form
has more options, though, which you can learn about from the <a class="reference external" href="http://docs.astropy.org/en/stable/api/astropy.units.quantity.Quantity.html">astropy
reference documentation on
Quantity</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">Reff</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can access the value and unit of a <code class="docutils literal"><span class="pre">Quantity</span></code> using the <code class="docutils literal"><span class="pre">value</span></code>
and <code class="docutils literal"><span class="pre">unit</span></code> attributes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Half light radius</span>
<span class="s2">value: {0}</span>
<span class="s2">unit: {1}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reff</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Reff</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Half light radius
value: 29.0
unit: pc
</pre></div></div>
</div>
<p>The <code class="docutils literal"><span class="pre">value</span></code> and <code class="docutils literal"><span class="pre">unit</span></code> attributes can also be accessed within the
print function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Half light radius</span>
<span class="s2">value: {0.value}</span>
<span class="s2">unit: {0.unit}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reff</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Half light radius
value: 29.0
unit: pc
</pre></div></div>
</div>
<p>Furthermore, we can convert the radius in parsecs to any other unit of
length using the <code class="docutils literal"><span class="pre">to()</span></code> method. Here, we convert it to meters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0:.3g}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reff</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8.95e+17 m
</pre></div></div>
</div>
<p>Next, we will first create a synthetic dataset of radial velocity
measurements, assuming a normal distribution with a mean velocity of 206
km/s and a velocity dispersion of 4.3 km/s.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">vmean</span> <span class="o">=</span> <span class="mi">206</span>
<span class="n">sigin</span> <span class="o">=</span> <span class="mf">4.3</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">vmean</span><span class="p">,</span> <span class="n">sigin</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;First 10 radial velocity measurements:</span>
<span class="s2">{0}</span>
<span class="s2">{1}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
First 10 radial velocity measurements:
[ 205.11975706  208.05945635  203.76641353  203.61035969  214.45285646
  211.99164508  206.39950387  207.21150846  209.30679704  211.35966937] km / s
[ 205119.75706422  208059.45635365  203766.41352526  203610.35969131
  214452.85646176  211991.64508178  206399.50387     207211.50845717
  209306.79704073  211359.66936646] m / s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Velocity (km/s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[10]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x10d870908&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_quantities_quantities_22_1.png" src="../../_images/tutorials_quantities_quantities_22_1.png" />
</div>
</div>
<p>Next, we calculate the velocity dispersion of the galaxy. This
demonstrates how you can perform basic operations like subtraction and
division with <code class="docutils literal"><span class="pre">Quantity</span></code> objects, and also use them in standard numpy
functions such as <code class="docutils literal"><span class="pre">mean()</span></code> and <code class="docutils literal"><span class="pre">size()</span></code>. They retain their units
through these operations just as you would expect them to.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Velocity dispersion: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Velocity dispersion: 4.36 km / s
</pre></div></div>
</div>
<p>Note how we needed to use <code class="docutils literal"><span class="pre">numpy</span></code> square root function, because the
resulting velocity dispersion quantity is a <code class="docutils literal"><span class="pre">numpy</span></code> array. If we used
the python standard <code class="docutils literal"><span class="pre">math</span></code> library’s <code class="docutils literal"><span class="pre">sqrt</span></code> function instead, we get
an error.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">sigma_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>In general, you should only use <code class="docutils literal"><span class="pre">numpy</span></code> functions with <code class="docutils literal"><span class="pre">Quantity</span></code>
objects, <em>not</em> the <code class="docutils literal"><span class="pre">math</span></code> equivalents, unless you are sure you
understand the consequences.</p>
<p>Now for the actual mass calculation. If a galaxy is pressure-supported
(for example, an elliptical or dwarf spheroidal galaxy), its mass within
the stellar extent can be estimated using a straightforward formula:
<img class="math" src="../../_images/math/65d433498313f1d5037d265b980d2d816a83bf39.png" alt="M_{1/2}=4\sigma^2 R_{eff}/G"/>. There are caveats to the use of
this formula for science - see Wolf et al. 2010 for details. For
demonstrating <code class="docutils literal"><span class="pre">Quantity</span></code>, just accept that this is often good enough.
For the calculation we can just multiply the quantities together, and
<code class="docutils literal"><span class="pre">astropy</span></code> will keep track of the units.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">M</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Reff</span><span class="o">/</span><span class="n">G</span>
<span class="n">M</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/2f83431e76afcc3f95005ddf56bd2b4c3aa7d5ae.png" alt="$3.3085932 \times 10^{13} \; \mathrm{\frac{km^{2}\,kg\,pc}{m^{3}}}$"/></p>
</div></div>
</div>
<p>The result is in a composite unit, so it’s not really obvious it’s a
mass. However, it can be decomposed to cancel all of the length units
(<img class="math" src="../../_images/math/e3146a8d4659d543382b6a8a4c3c688109de41d9.png" alt="km^2 pc/m^3"/>) using the decompose() method.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">M</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/fa0a38c8df52f9c27dd4397f49aadba0e02f75d2.png" alt="$1.0209252 \times 10^{36} \; \mathrm{kg}$"/></p>
</div></div>
</div>
<p>We can also easily express the mass in whatever form you like - solar
masses are common in astronomy, or maybe you want the default SI and CGS
units.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Galaxy mass</span>
<span class="s2">in solar units: {0:.3g}</span>
<span class="s2">SI units: {1:.3g}</span>
<span class="s2">CGS units: {2:.3g}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Msun</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">cgs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Galaxy mass
in solar units: 5.13e+05 solMass
SI units: 1.02e+36 kg
CGS units: 1.02e+39 g
</pre></div></div>
</div>
<p>Or, if you want the log of the mass, you can just use <code class="docutils literal"><span class="pre">np.log10</span></code> as
long as the logarithm’s argument is dimensionless.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Msun</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/5c09358e032387703c552ac425d66dc594d939f2.png" alt="$5.7104737 \; \mathrm{}$"/></p>
</div></div>
</div>
<p>However, you can’t take the log of something with units, as that is not
mathematically sensible.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UnitConversionError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity_helper.py</span> in <span class="ansi-cyan-fg">get_converter</span><span class="ansi-blue-fg">(from_unit, to_unit)</span>
<span class="ansi-green-intense-fg ansi-bold">     21</span>     <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 22</span><span class="ansi-red-fg">         </span>scale <span class="ansi-blue-fg">=</span> from_unit<span class="ansi-blue-fg">.</span>_to<span class="ansi-blue-fg">(</span>to_unit<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     23</span>     <span class="ansi-green-fg">except</span> UnitsError<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_to</span><span class="ansi-blue-fg">(self, other)</span>
<span class="ansi-green-intense-fg ansi-bold">    943</span>         raise UnitConversionError(
<span class="ansi-green-fg">--&gt; 944</span><span class="ansi-red-fg">             &#34;&#39;{0!r}&#39; is not a scaled version of &#39;{1!r}&#39;&#34;.format(self, other))
</span><span class="ansi-green-intense-fg ansi-bold">    945</span>

<span class="ansi-red-fg">UnitConversionError</span>: &#39;Unit(&#34;kg km2 pc / m3&#34;)&#39; is not a scaled version of &#39;Unit(dimensionless)&#39;

During handling of the above exception, another exception occurred:

<span class="ansi-red-fg">UnitConversionError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity_helper.py</span> in <span class="ansi-cyan-fg">helper_dimensionless_to_dimensionless</span><span class="ansi-blue-fg">(f, unit)</span>
<span class="ansi-green-intense-fg ansi-bold">    107</span>     <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 108</span><span class="ansi-red-fg">         return ([get_converter(unit, dimensionless_unscaled)],
</span><span class="ansi-green-intense-fg ansi-bold">    109</span>                 dimensionless_unscaled)

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity_helper.py</span> in <span class="ansi-cyan-fg">get_converter</span><span class="ansi-blue-fg">(from_unit, to_unit)</span>
<span class="ansi-green-intense-fg ansi-bold">     24</span>         return from_unit._apply_equivalencies(
<span class="ansi-green-fg">---&gt; 25</span><span class="ansi-red-fg">                 from_unit, to_unit, get_current_unit_registry().equivalencies)
</span><span class="ansi-green-intense-fg ansi-bold">     26</span>     <span class="ansi-green-fg">except</span> AttributeError<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_apply_equivalencies</span><span class="ansi-blue-fg">(self, unit, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    880</span>             &#34;{0} and {1} are not convertible&#34;.format(
<span class="ansi-green-fg">--&gt; 881</span><span class="ansi-red-fg">                 unit_str, other_str))
</span><span class="ansi-green-intense-fg ansi-bold">    882</span>

<span class="ansi-red-fg">UnitConversionError</span>: &#39;kg km2 pc / m3&#39; (mass) and &#39;&#39; (dimensionless) are not convertible

During handling of the above exception, another exception occurred:

<span class="ansi-red-fg">UnitTypeError</span>                             Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-17-598955917a11&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>np<span class="ansi-blue-fg">.</span>log10<span class="ansi-blue-fg">(</span>M<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity.py</span> in <span class="ansi-cyan-fg">__array_ufunc__</span><span class="ansi-blue-fg">(self, function, method, *inputs, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    619</span>         <span class="ansi-red-fg"># consistent units between two inputs (e.g., in np.add) --</span>
<span class="ansi-green-intense-fg ansi-bold">    620</span>         <span class="ansi-red-fg"># and the unit of the result (or tuple of units for nout &gt; 1).</span>
<span class="ansi-green-fg">--&gt; 621</span><span class="ansi-red-fg">         </span>converters<span class="ansi-blue-fg">,</span> unit <span class="ansi-blue-fg">=</span> converters_and_unit<span class="ansi-blue-fg">(</span>function<span class="ansi-blue-fg">,</span> method<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>inputs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    622</span>
<span class="ansi-green-intense-fg ansi-bold">    623</span>         out <span class="ansi-blue-fg">=</span> kwargs<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;out&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity_helper.py</span> in <span class="ansi-cyan-fg">converters_and_unit</span><span class="ansi-blue-fg">(function, method, *args)</span>
<span class="ansi-green-intense-fg ansi-bold">    459</span>         <span class="ansi-red-fg"># will have (this is a tuple of units if there are multiple outputs).</span>
<span class="ansi-green-intense-fg ansi-bold">    460</span>         <span class="ansi-green-fg">if</span> function <span class="ansi-green-fg">in</span> UFUNC_HELPERS<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 461</span><span class="ansi-red-fg">             </span>converters<span class="ansi-blue-fg">,</span> result_unit <span class="ansi-blue-fg">=</span> UFUNC_HELPERS<span class="ansi-blue-fg">[</span>function<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>function<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>units<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    462</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    463</span>             raise TypeError(&#34;Unknown ufunc {0}.  Please raise issue on &#34;

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity_helper.py</span> in <span class="ansi-cyan-fg">helper_dimensionless_to_dimensionless</span><span class="ansi-blue-fg">(f, unit)</span>
<span class="ansi-green-intense-fg ansi-bold">    111</span>         raise UnitTypeError(&#34;Can only apply &#39;{0}&#39; function to &#34;
<span class="ansi-green-intense-fg ansi-bold">    112</span>                             <span class="ansi-blue-fg">&#34;dimensionless quantities&#34;</span>
<span class="ansi-green-fg">--&gt; 113</span><span class="ansi-red-fg">                             .format(f.__name__))
</span><span class="ansi-green-intense-fg ansi-bold">    114</span>
<span class="ansi-green-intense-fg ansi-bold">    115</span>

<span class="ansi-red-fg">UnitTypeError</span>: Can only apply &#39;log10&#39; function to dimensionless quantities
</pre></div></div>
</div>
</div>
<div class="section" id="Exercises">
<h2>Exercises<a class="headerlink" href="#Exercises" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="docutils literal"><span class="pre">Quantity</span></code> and Kepler’s law in the form given below to determine
the (circular) orbital speed of the Earth around the sun in km/s. You
should not have to look up an constants or conversion factors to do this
calculation - it’s all in <code class="docutils literal"><span class="pre">astropy.units</span></code> and <code class="docutils literal"><span class="pre">astropy.constants</span></code>.</p>
<div class="math">
<p><img src="../../_images/math/332c8e1c4690f7aaf201ec5a51dfc7238f5c5846.png" alt="v = \sqrt{\frac{G M_{\odot}}{r}}"/></p>
</div><div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>There’s a much easier way to figure out the velocity of the Earth using
just two units or quantities. Do that and then compare to the Kepler’s
law answer (the easiest way is probably to compute the percentage
difference, if any).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>(Completely optional, but a good way to convince yourself of the value
of Quantity:) Do the above calculations by hand - you can use a
calculator (or python just for its arithmatic) but look up all the
appropriate conversion factors and use paper-and-pencil approaches for
keeping track of them all. Which one took longer?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="2.-Molecular-cloud-mass">
<h2>2. Molecular cloud mass<a class="headerlink" href="#2.-Molecular-cloud-mass" title="Permalink to this headline">¶</a></h2>
<p>In this second example, we will demonstrate how using <code class="docutils literal"><span class="pre">Quantity</span></code>
objects can facilitate a full derivation of the total mass of a
molecular cloud using radio observations of isotopes of Carbon Monoxide
(CO).</p>
<div class="section" id="Setting-up-the-data-cube">
<h3>Setting up the data cube<a class="headerlink" href="#Setting-up-the-data-cube" title="Permalink to this headline">¶</a></h3>
<p>Let’s assume that we have mapped the inner part of a molecular cloud in
the J=1-0 rotational transition of <img class="math" src="../../_images/math/3fe73bf79229b9913e8a4deacc779af5092c364f.png" alt="{\rm C}^{18}{\rm O}"/> and are
interested in measuring its total mass. The measurement produced a data
cube with RA and Dec as spatial coordiates and velocity as the third
axis. Each voxel in this data cube represents the brightness temperature
of the emission at that position and velocity. Furthermore, we will
assume that we have an independent measurement of distance to the cloud
<img class="math" src="../../_images/math/685feb973e1a18c53dfa6e64b8116b664f7b90db.png" alt="d=250"/> pc and that the excitation temperature is known and
constant throughout the cloud: <img class="math" src="../../_images/math/a02ec1f9da63c6a9f5f554fef23f954caaa45cec.png" alt="T_{ex}=25"/> K.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">d</span> <span class="o">=</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span>
<span class="n">Tex</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
</pre></div>
</div>
</div>
<p>We will generate a synthetic dataset, assuming the cloud follows a
Gaussian distribution in each of RA, Dec and velocity. We start by
creating a 100x100x300 numpy array, such that the first coordinate is
right ascension, the second is declination, and the third is velocity.
We use the <code class="docutils literal"><span class="pre">numpy.meshgrid</span></code> function to create data cubes for each of
the three coordinates, and then use them in the formula for a Gaussian
to generate an array with the synthetic data cube. In this cube, the
cloud is positioned at the center of the cube, with <img class="math" src="../../_images/math/011e5790a6c33043ceadca81d9657dde6c61d769.png" alt="\sigma"/> and
the center in each dimension shown below. Note in particular that the
<img class="math" src="../../_images/math/011e5790a6c33043ceadca81d9657dde6c61d769.png" alt="\sigma"/> for RA and Dec have different units from the center, but
<code class="docutils literal"><span class="pre">astropy</span></code> automatically does the relevant conversions before computing
the exponential.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Cloud&#39;s center</span>
<span class="n">cen_ra</span> <span class="o">=</span> <span class="mf">52.25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">cen_dec</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">cen_v</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="c1"># Cloud&#39;s size</span>
<span class="n">sig_ra</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span>
<span class="n">sig_dec</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span>
<span class="n">sig_v</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="c1">#1D coordinate quantities</span>
<span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mf">52.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span> <span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="c1">#this creates data cubes of size for each coordinate based on the dimensions of the other coordinates</span>
<span class="n">ra_cube</span><span class="p">,</span> <span class="n">dec_cube</span><span class="p">,</span> <span class="n">v_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="n">data_gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">ra_cube</span><span class="o">-</span><span class="n">cen_ra</span><span class="p">)</span><span class="o">/</span><span class="n">sig_ra</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">dec_cube</span><span class="o">-</span><span class="n">cen_dec</span><span class="p">)</span><span class="o">/</span><span class="n">sig_dec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">v_cube</span><span class="o">-</span><span class="n">cen_v</span><span class="p">)</span><span class="o">/</span><span class="n">sig_v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<p>The units of the exponential are dimensionless, so we multiply the data
cube by K to get brightness temperature units. Radio astronomers use a
rather odd set of units [K km/s] as of integrated intensity (that is,
summing all the emission from a line over velocity). As an aside for
experts, we’re setting up our artificial cube on the main-beam
temperature scale (T:math:<code class="xref py py-obj docutils literal"><span class="pre">_{rm</span> <span class="pre">MB}</span></code>) which is the closest we can
normally get to the actual brightness temperature of our source.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data_gauss</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
</pre></div>
</div>
</div>
<p>We will also need to know the width of each velocity bin and the size of
each pixel, so we calculate that now.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Average pixel size</span>
<span class="c1"># This is only right if dec ~ 0, because of the cos(dec) factor.</span>
<span class="n">dra</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ra</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
<span class="n">ddec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">dec</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

<span class="c1">#Average velocity bin width</span>
<span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;dra = {0}</span>
<span class="s2">ddec = {1}</span>
<span class="s2">dv = {2}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span> <span class="n">ddec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span> <span class="n">dv</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dra = 18.0 arcsec
ddec = 18.0 arcsec
dv = 0.1 km / s
</pre></div></div>
</div>
<p>We are interested in the integrated intensity over all of the velocity
channels, so we will create a 2D quantity array by summing our data cube
along the velocity axis (multiplying by the velocity width of a pixel).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">intcloud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">*</span><span class="n">dv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">intcloud</span><span class="o">.</span><span class="n">unit</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/d35025099764182140d6bce4cd2ebda37bcf5bbf.png" alt="$\mathrm{\frac{K\,km}{s}}$"/></p>
</div></div>
</div>
<p>We can plot the 2D quantity using matplotlib’s imshow function, by
passing the quantity’s value. Similarly, we can set the correct extent
using the values of <img class="math" src="../../_images/math/7720e563212e11bf72de255ab82c2a3b97c1a7f5.png" alt="x_i"/> and <img class="math" src="../../_images/math/2b2d000a23c13af8cd9eeabe3d2af78fd3c76d70.png" alt="x_f"/>. Finally, we can set the
colorbar label to have proper units.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1">#Note that we display RA in the convential way by going from max to min</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">intcloud</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
           <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
           <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
           <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Intensity ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intcloud</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA (deg)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dec (deg)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_quantities_quantities_59_0.png" src="../../_images/tutorials_quantities_quantities_59_0.png" />
</div>
</div>
</div>
<div class="section" id="Measuring-The-Column-Density-of-CO">
<h3>Measuring The Column Density of CO<a class="headerlink" href="#Measuring-The-Column-Density-of-CO" title="Permalink to this headline">¶</a></h3>
<p>In order to calculate the mass of the molecular cloud, we need to
measure its column density. A number of assumptions are required for the
following calculation; the most important are that the emission is
optically thin (typically true for <img class="math" src="../../_images/math/3fe73bf79229b9913e8a4deacc779af5092c364f.png" alt="{\rm C}^{18}{\rm O}"/>) and that
conditions of local thermodynamic equilibrium hold along the line of
sight. In the case where the temperature is large compared to the
separation in energy levels for a molecule and the source fills the main
beam of the telescope, the total column density for
<img class="math" src="../../_images/math/c7df378d53cb3c229829d6659e4a86061661b3f9.png" alt="{\rm C}^{13}{\rm O}"/> is</p>
<p><img class="math" src="../../_images/math/c3544251068cbdbc20695b0769d6813b20fb426d.png" alt="N=C \frac{\int T_B(V) dV}{1-e^{-B}}"/></p>
<p>where the constants <img class="math" src="../../_images/math/afce44aa7c55836ca9345404c22fc7b599d2ed84.png" alt="C"/> and <img class="math" src="../../_images/math/9805f44feec6f81d376d09e88b8236635edbb3c8.png" alt="B"/> are given by:</p>
<p><img class="math" src="../../_images/math/1dadd181208ab148fe635aa5ab3868d0cfd063cc.png" alt="C=3.0\times10^{14} \left(\frac{\nu}{\nu_{13}}\right)^2 \frac{A_{13}}{A} {\rm K^{-1} cm^{-2} \, km^{-1} \, s}"/></p>
<p><img class="math" src="../../_images/math/3c6c66cd32294b0dc6ef0dcd663df1ec41f59c10.png" alt="B=\frac{h\nu}{k_B T}"/></p>
<p>(Rohlfs &amp; Wilson “Tools of Radio Astronomy”).</p>
<p>Here we have given an expression for <img class="math" src="../../_images/math/afce44aa7c55836ca9345404c22fc7b599d2ed84.png" alt="C"/> scaled to the values for
<img class="math" src="../../_images/math/c7df378d53cb3c229829d6659e4a86061661b3f9.png" alt="{\rm C}^{13}{\rm O}"/> (<img class="math" src="../../_images/math/e3c6b0125ed0d9f8bc7d3693ea3f1089ab6e3f64.png" alt="\nu_{13}"/> and <img class="math" src="../../_images/math/19850d8b21d47eb8141612b4db5cc893450be17c.png" alt="A_{13}"/>). In
order to use this relation for <img class="math" src="../../_images/math/3fe73bf79229b9913e8a4deacc779af5092c364f.png" alt="{\rm C}^{18}{\rm O}"/>, we need to
rescale the frequencies <img class="math" src="../../_images/math/9535534059c2ab741bf1c4d319f0fdd808066dc4.png" alt="{\nu}"/> and Einstein coefficients
<img class="math" src="../../_images/math/0043fe6507e9b1d112e07a2801e24927e267dd50.png" alt="A"/>. <img class="math" src="../../_images/math/afce44aa7c55836ca9345404c22fc7b599d2ed84.png" alt="C"/> is in funny mixed units, but that’s okay. We’ll
define it as a <code class="docutils literal"><span class="pre">Quantities</span></code> object and not have to worry about it.</p>
<p>First, we look up the wavelength for these emission lines and store them
as quantities.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">lambda13</span> <span class="o">=</span> <span class="mf">2.60076</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
<span class="n">lambda18</span> <span class="o">=</span> <span class="mf">2.73079</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
</pre></div>
</div>
</div>
<p>Since the wavelength and frequency of light are related using the speed
of light, we can convert between them. However, doing so just using the
to() method fails, as units of length and frequency are not convertible:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">nu13</span> <span class="o">=</span> <span class="n">lambda13</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UnitConversionError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-25-b4a9b54d7f21&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>nu13 <span class="ansi-blue-fg">=</span> lambda13<span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>u<span class="ansi-blue-fg">.</span>Hz<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity.py</span> in <span class="ansi-cyan-fg">to</span><span class="ansi-blue-fg">(self, unit, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    842</span>         <span class="ansi-red-fg"># and don&#39;t want to slow down this method (esp. the scalar case).</span>
<span class="ansi-green-intense-fg ansi-bold">    843</span>         unit <span class="ansi-blue-fg">=</span> Unit<span class="ansi-blue-fg">(</span>unit<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 844</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_new_view<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_to_value<span class="ansi-blue-fg">(</span>unit<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> unit<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    845</span>
<span class="ansi-green-intense-fg ansi-bold">    846</span>     <span class="ansi-green-fg">def</span> to_value<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> unit<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity.py</span> in <span class="ansi-cyan-fg">_to_value</span><span class="ansi-blue-fg">(self, unit, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    814</span>             equivalencies <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_equivalencies
<span class="ansi-green-intense-fg ansi-bold">    815</span>         return self.unit.to(unit, self.view(np.ndarray),
<span class="ansi-green-fg">--&gt; 816</span><span class="ansi-red-fg">                             equivalencies=equivalencies)
</span><span class="ansi-green-intense-fg ansi-bold">    817</span>
<span class="ansi-green-intense-fg ansi-bold">    818</span>     <span class="ansi-green-fg">def</span> to<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> unit<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">to</span><span class="ansi-blue-fg">(self, other, value, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    975</span>             If units are inconsistent
<span class="ansi-green-intense-fg ansi-bold">    976</span>         &#34;&#34;&#34;
<span class="ansi-green-fg">--&gt; 977</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_get_converter<span class="ansi-blue-fg">(</span>other<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span>equivalencies<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">(</span>value<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    978</span>
<span class="ansi-green-intense-fg ansi-bold">    979</span>     <span class="ansi-green-fg">def</span> in_units<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1.0</span><span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_get_converter</span><span class="ansi-blue-fg">(self, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    909</span>                             <span class="ansi-green-fg">pass</span>
<span class="ansi-green-intense-fg ansi-bold">    910</span>
<span class="ansi-green-fg">--&gt; 911</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> exc
<span class="ansi-green-intense-fg ansi-bold">    912</span>
<span class="ansi-green-intense-fg ansi-bold">    913</span>     <span class="ansi-green-fg">def</span> _to<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_get_converter</span><span class="ansi-blue-fg">(self, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    895</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    896</span>             return self._apply_equivalencies(
<span class="ansi-green-fg">--&gt; 897</span><span class="ansi-red-fg">                 self, other, self._normalize_equivalencies(equivalencies))
</span><span class="ansi-green-intense-fg ansi-bold">    898</span>         <span class="ansi-green-fg">except</span> UnitsError <span class="ansi-green-fg">as</span> exc<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    899</span>             <span class="ansi-red-fg"># Last hope: maybe other knows how to do it?</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_apply_equivalencies</span><span class="ansi-blue-fg">(self, unit, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    879</span>         raise UnitConversionError(
<span class="ansi-green-intense-fg ansi-bold">    880</span>             &#34;{0} and {1} are not convertible&#34;.format(
<span class="ansi-green-fg">--&gt; 881</span><span class="ansi-red-fg">                 unit_str, other_str))
</span><span class="ansi-green-intense-fg ansi-bold">    882</span>
<span class="ansi-green-intense-fg ansi-bold">    883</span>     <span class="ansi-green-fg">def</span> _get_converter<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">UnitConversionError</span>: &#39;mm&#39; (length) and &#39;Hz&#39; (frequency) are not convertible
</pre></div></div>
</div>
<p>Fortunately, <code class="docutils literal"><span class="pre">astropy</span></code> comes to the rescue by providing a feature
called “unit equivalencies”. Equivalencies provide a way to convert
between two physically different units that are not normally equivalent,
but in a certain context have a one-to-one mapping. For more on
equivalencies, see the <a class="reference external" href="http://docs.astropy.org/en/stable/units/equivalencies.html">equivalencies section of astropy’s
documentation</a>.</p>
<p>In this case, calling the <code class="docutils literal"><span class="pre">astropy.units.spectral()</span></code> function provides
the equivalencies necessary to handle conversions between wavelength and
frequency. To use it, provide the equivalencies to the <code class="docutils literal"><span class="pre">equivalencies</span></code>
keyword of the <code class="docutils literal"><span class="pre">to()</span></code> call:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">nu13</span> <span class="o">=</span> <span class="n">lambda13</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
<span class="n">nu18</span> <span class="o">=</span> <span class="n">lambda18</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>Next, we look up Einstein coefficients (in units of s<img class="math" src="../../_images/math/32c47f7597d53ce7f2d3f4de3ce54a8bd5ac5d3c.png" alt="^{-1}"/>),
and calculate the ratios in constant <img class="math" src="../../_images/math/afce44aa7c55836ca9345404c22fc7b599d2ed84.png" alt="C"/>. Note how the ratios of
frequency and Einstein coefficient units are dimensionless, so the unit
of <img class="math" src="../../_images/math/afce44aa7c55836ca9345404c22fc7b599d2ed84.png" alt="C"/> is unchanged.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">A13</span> <span class="o">=</span> <span class="mf">7.4e-8</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
<span class="n">A18</span> <span class="o">=</span> <span class="mf">8.8e-8</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="n">C</span> <span class="o">=</span> <span class="mf">3e14</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu18</span><span class="o">/</span><span class="n">nu13</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">A13</span><span class="o">/</span><span class="n">A18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
<span class="n">C</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/6fe186e0d2673d095c60491a96101a7616874ac9.png" alt="$2.1792458 \times 10^{14} \; \mathrm{\frac{s}{K\,km\,cm^{2}}}$"/></p>
</div></div>
</div>
<p>Now we move on to calculate the constant <img class="math" src="../../_images/math/9805f44feec6f81d376d09e88b8236635edbb3c8.png" alt="B"/>. This is given by the
ratio of <img class="math" src="../../_images/math/b5702c071e6f0330ef0517952a97321eb8c42211.png" alt="\frac{h\nu}{k_B T}"/>, where <img class="math" src="../../_images/math/293fb39e1b93282c804a86186e721b32f829f1b2.png" alt="h"/> is Planck’s
constant, <img class="math" src="../../_images/math/9b7b651ab6210b690c07d6a9ec9c1c39ec2953fd.png" alt="k_B"/> is the Boltzmann’s constant, <img class="math" src="../../_images/math/ca3b8fa4180eee2dfc3af9d13fae1da451cd2c31.png" alt="\nu"/> is the
emission frequency, and <img class="math" src="../../_images/math/f2d283a2071f9d043c9e0b0f794a8880fa0d3ce9.png" alt="T"/> is the excitation temperature. The
constants were imported from <code class="docutils literal"><span class="pre">astropy.constants</span></code>, and the other two
values are already calculated, so here we just take the ratio.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">B</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">nu18</span> <span class="o">/</span> <span class="p">(</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">Tex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The units of <img class="math" src="../../_images/math/9805f44feec6f81d376d09e88b8236635edbb3c8.png" alt="B"/> are Hz s, which can be decomposed to a
dimensionless unit if you actually care about it’s value. Usually this
is not necessary, though. Quantities are at their best if you just use
them without worrying about intermediate units, and only convert at the
very end when you want a final answer.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;{0}</span><span class="se">\n</span><span class="s1">{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">decompose</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.21074888275227613 Hz s
0.21074888275227613
</pre></div></div>
</div>
<p>At this point we have all the ingredients to calculate the number
density of <img class="math" src="../../_images/math/8565d07b44df54440c2ce6fcbaffdd7750c95d33.png" alt="\rm CO"/> molecules in this cloud. We already integrated
(summed) over the velocity channels above to show the integrated
intensity map, but we’ll do it again here for clarity. This gives us the
column density of CO for each spatial pixel in our map. We can then
print out the peak column column density.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">NCO</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">*</span><span class="n">dv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Peak CO column density: &quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">NCO</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Peak CO column density:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/a273a6f49b48b2d1113dbbcbde0f34ceeb061021.png" alt="$8.5782066 \times 10^{15} \; \mathrm{\frac{1}{cm^{2}}}$"/></p>
</div></div>
</div>
</div>
<div class="section" id="CO-to-Total-Mass">
<h3>CO to Total Mass<a class="headerlink" href="#CO-to-Total-Mass" title="Permalink to this headline">¶</a></h3>
<p>We are using CO as a tracer for the much more numerous H<img class="math" src="../../_images/math/ba312cf0eeebc5f3ecc40ece2c744c499d75dc2d.png" alt="_2"/>,
the quantity we are actually trying to infer. Since most of the mass is
in H<img class="math" src="../../_images/math/ba312cf0eeebc5f3ecc40ece2c744c499d75dc2d.png" alt="_2"/>, we calculate its column density by multiplying the CO
column density with the (known/assumed) H<img class="math" src="../../_images/math/ba312cf0eeebc5f3ecc40ece2c744c499d75dc2d.png" alt="_2"/>/CO ratio.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">H2_CO_ratio</span> <span class="o">=</span> <span class="mf">5.9e6</span>
<span class="n">NH2</span> <span class="o">=</span> <span class="n">NCO</span> <span class="o">*</span> <span class="n">H2_CO_ratio</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Peak H2 column density: &quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">NH2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Peak H2 column density:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/3b8525f20c167530cc7c36a24c7d9d99661a081e.png" alt="$5.0611419 \times 10^{22} \; \mathrm{\frac{1}{cm^{2}}}$"/></p>
</div></div>
</div>
<p>That’s a peak column density of roughly 50 magnitudes of visual
extinction (assuming the conversion between N<img class="math" src="../../_images/math/f60a27148b6d14253af0f117cc2044c1b9ff3ca2.png" alt="_{\rm H_2}"/> and
A<img class="math" src="../../_images/math/3d3d7dd1e3c7aff6682fdd3f27ce0aa127b3ea96.png" alt="_V"/> from Bohlin et al. 1978), which seems reasonable for a
molecular cloud.</p>
<p>We obtain the mass column density by multiplying the number column
density by the mass of an individual H<img class="math" src="../../_images/math/ba312cf0eeebc5f3ecc40ece2c744c499d75dc2d.png" alt="_2"/> molecule.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">mH2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.008</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Dalton</span>  <span class="c1">#aka atomic mass unit/amu</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">NH2</span> <span class="o">*</span> <span class="n">mH2</span>
</pre></div>
</div>
</div>
<p>A final step in going from the column density to mass is summing up over
the area area. If we do this in the straightforward way of length x
width of a pixel, this area is then in units of <img class="math" src="../../_images/math/69c4d384a710e5b526d40a17c335d47c674fa00c.png" alt="{\rm deg}^2"/>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">dap</span> <span class="o">=</span> <span class="n">dra</span> <span class="o">*</span> <span class="n">ddec</span>
<span class="k">print</span><span class="p">(</span><span class="n">dap</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2.5e-05 deg2
</pre></div></div>
</div>
<p>Now comes an important subtlety: in the small angle approximation,
multiplying the pixel area with the square of distance yields the
cross-sectional area of the cloud that the pixel covers, in <em>physical</em>
units, rather than angular units. So it is tempting to just multiply the
area and the square of the distance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">da</span> <span class="o">=</span> <span class="n">dap</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># don&#39;t actually do it this way - use the version below instead!</span>
<span class="k">print</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.5625 deg2 pc2
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">dap</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">steradian</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/77d98dcfbe3e172dce3abead33cf0e4692ed8fb9.png" alt="$0.00047596472 \; \mathrm{pc^{2}}$"/></p>
</div></div>
</div>
<p>But this is <strong>wrong</strong>, because <code class="docutils literal"><span class="pre">astropy.units</span></code> treats angles (and
solid angles) as actual physical units, while the small-angle
approximation assumes angles are dimensionless. So if you, e.g., try to
convert to a different area unit, it will fail:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">da</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UnitConversionError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-36-d7c4d4dcf9cc&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>da<span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>u<span class="ansi-blue-fg">.</span>cm<span class="ansi-blue-fg">**</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity.py</span> in <span class="ansi-cyan-fg">to</span><span class="ansi-blue-fg">(self, unit, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    842</span>         <span class="ansi-red-fg"># and don&#39;t want to slow down this method (esp. the scalar case).</span>
<span class="ansi-green-intense-fg ansi-bold">    843</span>         unit <span class="ansi-blue-fg">=</span> Unit<span class="ansi-blue-fg">(</span>unit<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 844</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_new_view<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_to_value<span class="ansi-blue-fg">(</span>unit<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> unit<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    845</span>
<span class="ansi-green-intense-fg ansi-bold">    846</span>     <span class="ansi-green-fg">def</span> to_value<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> unit<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity.py</span> in <span class="ansi-cyan-fg">_to_value</span><span class="ansi-blue-fg">(self, unit, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    814</span>             equivalencies <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_equivalencies
<span class="ansi-green-intense-fg ansi-bold">    815</span>         return self.unit.to(unit, self.view(np.ndarray),
<span class="ansi-green-fg">--&gt; 816</span><span class="ansi-red-fg">                             equivalencies=equivalencies)
</span><span class="ansi-green-intense-fg ansi-bold">    817</span>
<span class="ansi-green-intense-fg ansi-bold">    818</span>     <span class="ansi-green-fg">def</span> to<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> unit<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">to</span><span class="ansi-blue-fg">(self, other, value, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    975</span>             If units are inconsistent
<span class="ansi-green-intense-fg ansi-bold">    976</span>         &#34;&#34;&#34;
<span class="ansi-green-fg">--&gt; 977</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_get_converter<span class="ansi-blue-fg">(</span>other<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span>equivalencies<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">(</span>value<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    978</span>
<span class="ansi-green-intense-fg ansi-bold">    979</span>     <span class="ansi-green-fg">def</span> in_units<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">,</span> value<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1.0</span><span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_get_converter</span><span class="ansi-blue-fg">(self, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    909</span>                             <span class="ansi-green-fg">pass</span>
<span class="ansi-green-intense-fg ansi-bold">    910</span>
<span class="ansi-green-fg">--&gt; 911</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> exc
<span class="ansi-green-intense-fg ansi-bold">    912</span>
<span class="ansi-green-intense-fg ansi-bold">    913</span>     <span class="ansi-green-fg">def</span> _to<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_get_converter</span><span class="ansi-blue-fg">(self, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    895</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    896</span>             return self._apply_equivalencies(
<span class="ansi-green-fg">--&gt; 897</span><span class="ansi-red-fg">                 self, other, self._normalize_equivalencies(equivalencies))
</span><span class="ansi-green-intense-fg ansi-bold">    898</span>         <span class="ansi-green-fg">except</span> UnitsError <span class="ansi-green-fg">as</span> exc<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    899</span>             <span class="ansi-red-fg"># Last hope: maybe other knows how to do it?</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/core.py</span> in <span class="ansi-cyan-fg">_apply_equivalencies</span><span class="ansi-blue-fg">(self, unit, other, equivalencies)</span>
<span class="ansi-green-intense-fg ansi-bold">    879</span>         raise UnitConversionError(
<span class="ansi-green-intense-fg ansi-bold">    880</span>             &#34;{0} and {1} are not convertible&#34;.format(
<span class="ansi-green-fg">--&gt; 881</span><span class="ansi-red-fg">                 unit_str, other_str))
</span><span class="ansi-green-intense-fg ansi-bold">    882</span>
<span class="ansi-green-intense-fg ansi-bold">    883</span>     <span class="ansi-green-fg">def</span> _get_converter<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> other<span class="ansi-blue-fg">,</span> equivalencies<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">UnitConversionError</span>: &#39;deg2 pc2&#39; and &#39;cm2&#39; (area) are not convertible
</pre></div></div>
</div>
<p>The solution is to use the <code class="docutils literal"><span class="pre">dimensionless_angles</span></code> equivalency, which
allows angles to be treated as dimensionless. This makes it so that they
will automatically convert to radians and become dimensionless when a
conversion is needed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">dap</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span>
<span class="n">da</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/77d98dcfbe3e172dce3abead33cf0e4692ed8fb9.png" alt="$0.00047596472 \; \mathrm{pc^{2}}$"/></p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">da</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/04d5822a83953e4caf3e818602603efa2565409f.png" alt="$4.5318534 \times 10^{33} \; \mathrm{cm^{2}}$"/></p>
</div></div>
</div>
<p>Finally, multiplying the column density with the pixel area and summing
over all the pixels gives us the cloud mass.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">da</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">solMass</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/a893f0dce8e2d70de9053a7bc2afbe0be3747a09.png" alt="$317.63786 \; \mathrm{M_{\odot}}$"/></p>
</div></div>
</div>
</div>
</div>
<div class="section" id="Exercises">
<h2>Exercises<a class="headerlink" href="#Exercises" title="Permalink to this headline">¶</a></h2>
<p>The astro material was pretty heavy on that one, so lets focus on some
associated statistics using <code class="docutils literal"><span class="pre">Quantity</span></code>’s array capabililities. Compute
the median and mean of the <code class="docutils literal"><span class="pre">data</span></code> with the <code class="docutils literal"><span class="pre">np.mean</span></code> and
<code class="docutils literal"><span class="pre">np.median</span></code> functions. Why are their values so different?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>Similarly, compute the standard deviation and variance (if you don’t
know the relevant functions, look it up in the numpy docs or just type
np. and a code cell). Do they have the units you expect?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="3.-Using-Quantities-with-Functions">
<h2>3. Using Quantities with Functions<a class="headerlink" href="#3.-Using-Quantities-with-Functions" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">Quantity</span></code> is also a useful tool if you plan to share some of your
code, either with collaborators or the wider community. By writing
functions that take <code class="docutils literal"><span class="pre">Quantity</span></code> objects instead of raw numbers or
arrays, you can write code that is agnostic to the input unit. In this
way, you may even be able to prevent <a class="reference external" href="http://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure">the destruction of Mars
orbiters</a>.
Below, we provide a simple example.</p>
<p>Suppose you are working on an instrument, and the bigwig funding it asks
for a function to give an analytic estimate of the response function.
You determine from some tests it’s basically a Lorentzian, but with a
different scale along the two axes. Your first thought might be to do
this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">response_func</span><span class="p">(</span><span class="n">xinarcsec</span><span class="p">,</span> <span class="n">yinarcsec</span><span class="p">):</span>
    <span class="n">xscale</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">yscale</span> <span class="o">=</span> <span class="mf">0.85</span>
    <span class="n">xfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">xinarcsec</span><span class="o">/</span><span class="n">xscale</span><span class="p">)</span>
    <span class="n">yfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">yinarcsec</span><span class="o">/</span><span class="n">yscale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xfactor</span> <span class="o">*</span> <span class="n">yfactor</span>
</pre></div>
</div>
</div>
<p>You meant the inputs to be in arcsec, but you send that to your hapless
collaborator, and they don’t look closely and think the inputs are
instead supposed to be in arcmin. So they do:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[41]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>0.19640564826700893
</pre></div>
</div>
</div>
<p>And now they tell all their friends how terrible the instrument is,
because it’s supposed to have arcsecond resolution, but your function
clearly shows it can only resolve an arcmin at best. But you can solve
this by requiring they pass in <code class="docutils literal"><span class="pre">Quantity</span></code> objects. The new function
could simply be:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">response_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">xscale</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="n">yscale</span> <span class="o">=</span> <span class="mf">0.85</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="n">xfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="o">/</span><span class="n">xscale</span><span class="p">)</span>
    <span class="n">yfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="o">/</span><span class="n">yscale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xfactor</span> <span class="o">*</span> <span class="n">yfactor</span>
</pre></div>
</div>
</div>
<p>And your collaborator now has to pay attention. If they just blindly put
in a number they get an error:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UnitsError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-43-5d7d1ca80126&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>response_func<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1.0</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1.2</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-42-c1a22f103934&gt;</span> in <span class="ansi-cyan-fg">response_func</span><span class="ansi-blue-fg">(x, y)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span>     xscale <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0.9</span> <span class="ansi-blue-fg">*</span> u<span class="ansi-blue-fg">.</span>arcsec
<span class="ansi-green-intense-fg ansi-bold">      3</span>     yscale <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0.85</span> <span class="ansi-blue-fg">*</span> u<span class="ansi-blue-fg">.</span>arcsec
<span class="ansi-green-fg">----&gt; 4</span><span class="ansi-red-fg">     </span>xfactor <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-blue-fg">/</span> <span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1</span> <span class="ansi-blue-fg">+</span> x<span class="ansi-blue-fg">/</span>xscale<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>     yfactor <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-blue-fg">/</span> <span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1</span> <span class="ansi-blue-fg">+</span> y<span class="ansi-blue-fg">/</span>yscale<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity.py</span> in <span class="ansi-cyan-fg">__array_ufunc__</span><span class="ansi-blue-fg">(self, function, method, *inputs, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    619</span>         <span class="ansi-red-fg"># consistent units between two inputs (e.g., in np.add) --</span>
<span class="ansi-green-intense-fg ansi-bold">    620</span>         <span class="ansi-red-fg"># and the unit of the result (or tuple of units for nout &gt; 1).</span>
<span class="ansi-green-fg">--&gt; 621</span><span class="ansi-red-fg">         </span>converters<span class="ansi-blue-fg">,</span> unit <span class="ansi-blue-fg">=</span> converters_and_unit<span class="ansi-blue-fg">(</span>function<span class="ansi-blue-fg">,</span> method<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>inputs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    622</span>
<span class="ansi-green-intense-fg ansi-bold">    623</span>         out <span class="ansi-blue-fg">=</span> kwargs<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;out&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda/envs/tutorials-dev/lib/python3.6/site-packages/astropy/units/quantity_helper.py</span> in <span class="ansi-cyan-fg">converters_and_unit</span><span class="ansi-blue-fg">(function, method, *args)</span>
<span class="ansi-green-intense-fg ansi-bold">    481</span>                                      <span class="ansi-blue-fg">&#34;argument is not a quantity (unless the &#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    482</span>                                      <span class="ansi-blue-fg">&#34;latter is all zero/infinity/nan)&#34;</span>
<span class="ansi-green-fg">--&gt; 483</span><span class="ansi-red-fg">                                      .format(function.__name__))
</span><span class="ansi-green-intense-fg ansi-bold">    484</span>             <span class="ansi-green-fg">except</span> TypeError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    485</span>                 <span class="ansi-red-fg"># _can_have_arbitrary_unit failed: arg could not be compared</span>

<span class="ansi-red-fg">UnitsError</span>: Can only apply &#39;add&#39; function to dimensionless quantities when other argument is not a quantity (unless the latter is all zero/infinity/nan)
</pre></div></div>
</div>
<p>Which is their cue to provide the units explicitly:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math">
<p><img src="../../_images/math/230789c4a4067929e20e5d7504512c068bc12f90.png" alt="$0.0001724307 \; \mathrm{}$"/></p>
</div></div>
</div>
<p>The funding agency is impressed at the resolution you achieved, and your
instrument is saved. You now go on to win the Nobel Prize due to
discoveries the instrument makes. And it was all because you used
<code class="docutils literal"><span class="pre">Quantity</span></code> as the input of code you shared.</p>
</div>
<div class="section" id="Exercise">
<h2>Exercise<a class="headerlink" href="#Exercise" title="Permalink to this headline">¶</a></h2>
<p>Write a function that computes the Keplerian velocity you worked out in
section 1 (using <code class="docutils literal"><span class="pre">Quantity</span></code> input and outputs, of course), but
allowing for an arbitrary mass and orbital radius. Try it with some
reasonable numbers for satellites orbiting the Earth, a moon of Jupiter,
or an extrasolar planet. Feel free to use wikipedia or similar for the
masses and distances.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<hr width="75%" style="margin: 0 auto; margin-top: 16px; margin-bottom: 16px;" />
<p style="text-align: center; width: 100%; font-size:125%;">
    <a href="https://github.com/astropy/astropy-tutorials/tree/master/docs//tutorials/quantities/quantities.ipynb">Source notebook</a>
</p>
<hr width="75%" style="margin: 0 auto; margin-top: 16px; margin-bottom: 16px;" /></div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Using Astropy Quantities for astrophysical calculations</a><ul>
<li><a class="reference internal" href="#Preliminaries">Preliminaries</a></li>
<li><a class="reference internal" href="#1.-Galaxy-mass">1. Galaxy mass</a></li>
<li><a class="reference internal" href="#Exercises">Exercises</a></li>
<li><a class="reference internal" href="#2.-Molecular-cloud-mass">2. Molecular cloud mass</a><ul>
<li><a class="reference internal" href="#Setting-up-the-data-cube">Setting up the data cube</a></li>
<li><a class="reference internal" href="#Measuring-The-Column-Density-of-CO">Measuring The Column Density of CO</a></li>
<li><a class="reference internal" href="#CO-to-Total-Mass">CO to Total Mass</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Exercises">Exercises</a></li>
<li><a class="reference internal" href="#3.-Using-Quantities-with-Functions">3. Using Quantities with Functions</a></li>
<li><a class="reference internal" href="#Exercise">Exercise</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../_sources/tutorials/quantities/quantities.ipynb.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2013–2017, The Astropy Developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3. &nbsp;
    Last built 10 Oct 2017. <br/>
  </p>
</footer>
  </body>
</html>